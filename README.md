# Raspberry pi 5, hid setup, working
- only for normal keys sending, not for mouse or media control keys
- link https://blog.hardill.me.uk/2023/12/23/pi5-usb-c-gadget/
    - the link is related but not this specific content

- This generated by perplexity, by giving it context of some original source
Raspberry Pi 5 supports USB gadget mode via configfs on the official Raspberry Pi OS (Bookworm or later), but requires specific firmware updates and config changes due to the new RP1 chip. Ben Hardill's guide (referenced in recent articles) provides the foundation, adapted here for HID keyboard use instead of Ethernet.[1]

Follow these exact steps on a fresh or updated Raspberry Pi OS on your Pi 5; test with Ethernet first, then swap for HID.

## Update Firmware and OS

Run these commands on the Pi (via SSH or monitor):
```
sudo apt update && sudo apt full-upgrade -y
sudo rpi-update
sudo reboot
```
This pulls Pi 5-specific RP1 USB gadget support; older images lack it.[1]

## Edit Boot Config Files

1. Edit `/boot/config.txt` (now `/boot/firmware/config.txt` on Bookworm):
```
sudo nano /boot/firmware/config.txt
```
Add at the end:
```
dtoverlay=dwc2
```
Save and exit.

-- some change
[all]
dtoverlay=dwc2

[cm5]
dtoverlay=dwc2,dr_mode=peripheral


2. Edit `/boot/cmdline.txt`:
```
sudo nano /boot/firmware/cmdline.txt
```
Add to the **end of the single line** (with leading space, no newline):
```
modules-load=dwc2,libcomposite
```
Example full line: `console=serial0,115200 console=tty1 root=PARTUUID=... rootfstype=ext4 ... modules-load=dwc2,libcomposite`

3. Add module to `/etc/modules`:
```
echo "libcomposite" | sudo tee -a /etc/modules
```
Reboot:
```
sudo reboot
```

## Create HID Keyboard Gadget Script

Create `/usr/local/bin/usb-hid-keyboard.sh` (Pi 5 path differs slightly from older guides):
```
sudo nano /usr/local/bin/usb-hid-keyboard.sh
```
Paste this HID-specific script (adapted from Hardill's configfs Ethernet example for keyboard):
```bash
#!/bin/bash
modprobe libcomposite

cd /sys/kernel/config/usb_gadget/
mkdir -p pi_keyboard
cd pi_keyboard

# USB identifiers (standard for HID keyboard compatibility with Windows)
echo 0x1d6b > idVendor  # Linux Foundation
echo 0x0104 > idProduct # HID Keyboard
echo 0x0100 > bcdDevice # v1.0.0
echo 0x0200 > bcdUSB    # USB 2.0

mkdir -p strings/0x409
echo "fedcba9876543210" > strings/0x409/serialnumber
echo "Raspberry Pi"     > strings/0x409/manufacturer
echo "Pi HID Keyboard"  > strings/0x409/product

mkdir -p configs/c.1/strings/0x409
echo "HID Config"     > configs/c.1/strings/0x409/configuration
echo 500              > configs/c.1/MaxPower
echo 0xa0             > configs/c.1/bmAttributes # Self-powered, remote wakeup

# HID function for keyboard (report descriptor for boot keyboard)
mkdir -p functions/hid.usb0
echo 1 > functions/hid.usb0/protocol    # Keyboard
echo 1 > functions/hid.usb0/subclass    # Boot interface
echo 3 > functions/hid.usb0/report_length

# Standard USB HID keyboard report descriptor (8 bytes: modifiers, reserved, 6 keys)
echo -ne \\x05\\x01\\x09\\x06\\xa1\\x01\\x05\\x07\\x19\\xe0\\x29\\xe7\\x15\\x00\\x25\\x01\\x75\\x01\\x95\\x08\\x81\\x02\\x95\\x01\\x75\\x08\\x81\\x03\\x95\\x05\\x75\\x01\\x05\\x08\\x19\\x01\\x29\\x05\\x91\\x02\\x95\\x01\\x75\\x03\\x91\\x03\\x95\\x06\\x75\\x08\\x15\\x00\\x25\\x65\\x05\\x07\\x19\\x00\\x29\\x65\\x81\\x00\\xc0 > functions/hid.usb0/report_desc

ln -s functions/hid.usb0 configs/c.1/

udevadm settle
ls /sys/class/udc > UDC  # Bind to Pi 5 UDC (e.g., dwc2 or rp1_udc)
```
Make executable:
```
sudo chmod +x /usr/local/bin/usb-hid-keyboard.sh
```
This creates `/dev/hidg0` for writing keyboard reports.[2]

## Enable at Boot

Create systemd service:
```
sudo nano /etc/systemd/system/usb-hid.service
```
Paste:
```
[Unit]
Description=USB HID Keyboard Gadget
After=sysfsinit.target systemd-modules-load.service
Wants=sysfsinit.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/local/bin/usb-hid-keyboard.sh

[Install]
WantedBy=multi-user.target
```
Enable:
```
sudo systemctl daemon-reload
sudo systemctl enable usb-hid.service
sudo reboot
```

## Test Connection

1. Power off Pi 5.
2. Connect **data-capable USB-C cable** from Pi 5 USB-C (power port) to Windows USB port.
3. Power on Pi 5.
4. On Windows: Check Device Manager for "Pi HID Keyboard" under Human Interface Devices.[1]
5. On Pi: `ls /dev/hid*` shows `/dev/hidg0`.
6. Test: `echo -ne '\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00' > /dev/hidg0` (types 'A').[2]

Your GPIO matrix code can now write HID reports to `/dev/hidg0` for custom keys.


# Raspberry pi 5 pin diagram  

| GPIO Pin # | Pin # || Pin # | GPIO Pin # |
|------------|--------||--------|-------------|
|     -      |   1    ||   2    |     -       |
|     2      |   3    ||   4    |     -       |
|     3      |   5    ||   6    |     -       |
|     4      |   7    ||   8    |     14      |
|     -      |   9    ||  10    |     15      |
|    17      |  11    ||  12    |     18      |
|    27      |  13    ||  14    |     -       |
|    22      |  15    ||  16    |     23      |
|     -      |  17    ||  18    |     24      |
|    10      |  19    ||  20    |     -       |
|     9      |  21    ||  22    |     25      |
|    11      |  23    ||  24    |     8       |
|     -      |  25    ||  26    |     7       |
|     0      |  27    ||  28    |     1       |
|     5      |  29    ||  30    |     -       |
|     6      |  31    ||  32    |     12      |
|    13      |  33    ||  34    |     -       |
|    19      |  35    ||  36    |     16      |
|    26      |  37    ||  38    |     20      |
|     -      |  39    ||  40    |     21      |


## About This Project, From original github repo
This project focuses on a simple way to set up a Raspberry Pi 4B/5 (and maybe others) as a USB HID device. It can be installed via a one-liner.

I created this because I was getting really annoyed about the lack of info on using Pis other than the Zero as USB HID devices. There are many posts that mention doing it, but they never seem to work. There are also many posts saying only the Pico or Zero can do it.

I've tested it on a Raspberry Pi 4B 8GB model from 2018, running Raspberry Pi OS lite (32-bit), Debian Bookworm. It probably works on 64-bit but I haven't tried it yet. Someone else has tested it on a Raspberry Pi 5, which worked fine.

> [!IMPORTANT]
> Install and library are in the [wiki](https://github.com/rikka-chunibyo/HIDPi/wiki)
> 
> Docs are [here](https://rikka-chunibyo.github.io/hidpi-docs/hidpi.html)

## Issues
I usually respond fast, I honestly don't know much about all of this, I just scrapped together some commands and stuff, but I'll try my best to help. 

If there's an issue while your using a different OS, please open an issue about adding support for it, I'd like this project to be as plug-and-play and simple as possible.

Not really about issues but if you have any suggestions for improvements or anything feel free to open a discussion about it.

Please create an issue if something is unclear or wrong, I used AI to generate the comments which are used to generate documentation.



# Git SSH Authentication
- Create a dir for the key pair
mkdir -p ~/.ssh/GitAuthentication/CustomKeyboard_01/

- Generate a key pair
ssh-keygen -t rsa -b 4096 -C "saptarshibhosale604@gmail.com" -f ~/.ssh/GitAuthentication/CustomKeyboard_01/id_rsa

- Start the ssh agent
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/GitAuthentication/CustomKeyboard_01/id_rsa

- Check the key
cat ~/.ssh/GitAuthentication/CustomKeyboard_01/id_rsa.pub

- Add the key to Github account
GitHub > Settings > SSH and GPG Keys > New SSH key > Paste the key > save

- Test connection
ssh -T git@github.com






# /sys/kernel/config/usb_gadget/hid_gadget delete the gadget, 

You must unbind the gadget from UDC before deleting it.

1️⃣ Go to gadget directory
cd /sys/kernel/config/usb_gadget/hid_gadget

2️⃣ Unbind the gadget from USB controller

Check what UDC is bound:

cat UDC


Unbind it:

echo "" | sudo tee UDC


✅ At this point, /dev/hidg0 and /dev/hidg1 should disappear.

hid_gadget ➤ ls /dev/hidg*                       
- working till now ^

- note remove directory, do not rm .

3️⃣ Remove function links
cd configs/c.1/
sudo rm -f hid.usb0
sudo rm -f hid.usb1

4️⃣ Remove HID functions
cd ../../functions/
sudo rmdir hid.usb0
sudo rmdir hid.usb1

5️⃣ Remove config strings (if present)
cd ../configs/c.1/strings/0x409
sudo rmdir .

6️⃣ Remove config
cd ..
sudo rmdir c.1

7️⃣ Remove gadget strings
cd ../strings/0x409
sudo rmdir .

8️⃣ Finally delete the gadget
cd ..
sudo rmdir hid_gadget

✅ Verify deletion
ls /sys/kernel/config/usb_gadget/

- OR run 
Old ➤ sudo ./cleanupGadget02.sh                                 git:main*





- create the hid device in this location 
/sys/kernel/config/usb_gadget,
create a autorunning service

 CustomKeyboard ➤ sudo python ./library/Old/HIDPi_Setup.py

- Only create a hid device
HIDPi_Setup_02.py

-  given by chatgpt
hid_gadget ➤ xxd /sys/kernel/config/usb_gadget/hid_gadget/functions/hid.usb1/report_desc                                                                   
00000000: 0501 0902 a101 0901 a100 0509 1901 2903  ..............).
00000010: 1500 2501 9503 7501 8102 9501 7505 8103  ..%...u.....u...
00000020: 0501 0930 0931 1581 257f 7508 9502 8106  ...0.1..%.u.....
00000030: c0c0                                     ..
hid_gadget ➤                                                                                                                                               

- cmds
sudo rm /sys/kernel/config/usb_gadget/hid_gadget/configs/c.1/hid.usb1
sudo sh -c 'echo "" > /sys/kernel/config/usb_gadget/hid_gadget/UDC'

echo 4 | sudo tee /sys/kernel/config/usb_gadget/hid_gadget/functions/hid.usb1/report_length


sudo sh -c 'printf "\
\x05\x01\x09\x02\xa1\x01\x09\x01\xa1\x00\
\x05\x09\x19\x01\x29\x03\x15\x00\x25\x01\
\x95\x03\x75\x01\x81\x02\x95\x01\x75\x05\
\x81\x03\x05\x01\x09\x30\x09\x31\x09\x38\
\x15\x81\x25\x7f\x75\x08\x95\x03\x81\x06\
\xc0\xc0" > /sys/kernel/config/usb_gadget/hid_gadget/functions/hid.usb1/report_desc'


sudo ln -s /sys/kernel/config/usb_gadget/hid_gadget/functions/hid.usb1 \
/sys/kernel/config/usb_gadget/hid_gadget/configs/c.1/

ls /sys/class/udc
sudo sh -c 'echo 1000480000.usb > /sys/kernel/config/usb_gadget/hid_gadget/UDC'




- 
| Feature / Field   | First Descriptor (xxd dump) | Second Descriptor (printf) |
|------------------|-----------------------------|-----------------------------|
| Scroll Wheel     | ❌ Not present              | ✅ Present (`Usage 0x38`)   |
| Axis Usages      | X, Y                         | X, Y, Wheel                |
| Report Count     | 2 (X, Y)                     | 3 (X, Y, Wheel)            |
| Total Report Size| 3 bytes                      | 4 bytes                    |


| Feature / Field   | First Descriptor (xxd dump) | Second Descriptor (printf) |
|------------------|-----------------------------|-----------------------------|
| Device Type      | HID Mouse                    | HID Mouse                  |
| Button Count     | 3                            | 3                          |
| X Axis           | Yes                          | Yes                        |
| Y Axis           | Yes                          | Yes                        |
| Logical Range    | -127 to +127                 | -127 to +127               |
| Report Size      | 8 bits per axis              | 8 bits per axis            |
| Button Bits      | 3 bits                       | 3 bits                     |
| Padding Bits     | 5 bits                       | 5 bits                     |
| Expected Report  | `[buttons][X][Y]`            | `[buttons][X][Y][wheel]`   |
| OS Impact        | Mouse movement only          | Mouse + scroll support     |





# https://github.com/thewh1teagle/zero-hid.git

- mouse movement is here
- descriptor for this mouse and OLD keyboard is working

