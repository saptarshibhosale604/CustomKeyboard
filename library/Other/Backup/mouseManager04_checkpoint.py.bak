"""
mouseManager.py

Terminal-based mouse controller using keyboard input.
No external libraries required.

Key mappings:
- Hold 'h' -> move right
- Hold 'l' -> move left
- Hold 'j' -> move down
- Hold 'd' -> move up
- Press 'u' -> left click
- Press 'i' -> right click
- Press 'p' -> quit program
"""

import sys
import termios
import tty
import select
import time
# from time import sleep
# from time import sleep, time
from zero_hid import Mouse

# =========================
# Configuration
# =========================

moveStep = 10
# moveStep = 2
# moveStep = 20
# loopDelay = 0.1
mouseLoopDelay = 0.01
maxDelta = 127
breakMouseLoopTime = 0.2 # Break the mouse loop after this time

# =========================
# Mouse Helpers
# =========================

def MoveRelative(mouse, dx, dy):
    """
    Move mouse using HID-safe deltas.
    """
    try:
        while dx != 0 or dy != 0:
            stepX = max(-maxDelta, min(maxDelta, dx))
            stepY = max(-maxDelta, min(maxDelta, dy))

            print(f"MoveRelative::")
            print(f"stepX: {stepX}")
            print(f"stepY: {stepY}")
            # time.sleep(3)

            mouse.move(stepX, stepY)

            dx -= stepX
            dy -= stepY
    except Exception as exc:
        print(f"\n‚ö†Ô∏è Mouse movement error: {exc}")


# =========================
# Info Helpers
# =========================

def PrintStartupInfo():
    """
    Print control instructions.
    """
    print("\n================ Mouse Controller Started ================\n")
    print("\nControls:")
    print("\n  h  -> move right (hold)")
    print("\n  l  -> move left  (hold)")
    print("\n  j  -> move down  (hold)")
    print("\n  d  -> move up    (hold)")
    print("\n  u  -> left click")
    print("\n  i  -> right click")
    print("\n  p  -> quit")
    print("\n==========================================================\n")


# =========================
# Main Logic
# =========================

# from time import sleep, time

def MouseMovementLoop():
    """
    Program entry point.
    """
    global movement_up
    global movement_down
    global movement_left
    global movement_right
    global isMouseMovementLoopOn

    isMouseMovementLoopOn = True
    lastMouseActionTime = time.time()   # Track last movement timestamp

    try:
        with Mouse(absolute=False) as mouse:
            while True:
                mouseAction = False  # Flag to detect movement in this iteration

                # Debug / status output
                print(
                    f"UP={movement_up}, "
                    f"DOWN={movement_down}, "
                    f"LEFT={movement_left}, "
                    f"RIGHT={movement_right}"
                )

                # if click_left
                #     # def left_click(self, release=True):
                #     mouse.left_click()
                #     mouseAction = True

                if movement_left:
                    MoveRelative(mouse, -moveStep, 0)
                    mouseAction = True

                if movement_right:
                    MoveRelative(mouse, moveStep, 0)
                    mouseAction = True

                if movement_down:
                    MoveRelative(mouse, 0, moveStep)
                    mouseAction = True

                if movement_up:
                    MoveRelative(mouse, 0, -moveStep)
                    mouseAction = True

                # Update last movement time if movement occurred
                if mouseAction:
                    lastMouseActionTime = time.time()
                else:
                    # Break if no movement for 2 seconds
                    if time.time() - lastMouseActionTime >= breakMouseLoopTime:
                        print(f"\n‚èπÔ∏è No movement for {breakMouseLoopTime} Seconds. Stopping loop.")
                        break

                time.sleep(mouseLoopDelay)

    except KeyboardInterrupt:
        print("\n\nüõë Interrupted by user")

    except Exception as exc:
        print(f"\n‚ùå Fatal error: {exc}")

    finally:
        isMouseMovementLoopOn = False
        print("\nMouse Control Stopped")

# def MouseMovementLoop():
#     """
#     Program entry point.
#     """
#     global movement_up
#     global movement_down
#     global movement_left
#     global movement_right
#     global isMouseMovementLoopOn
#
#     # oldTerminalSettings = None
#     isMouseMovementLoopOn = True
#
#     try:
#         # oldTerminalSettings = SetRawMode()
#         # PrintStartupInfo()
#
#         with Mouse(absolute=False) as mouse:
#             while True:
#                 # key = ReadKey()
#
#                 if movement_left:
#                     # print("\r‚û°Ô∏è  Moving Left   ")
#                     MoveRelative(mouse, -moveStep, 0)
#
#                 if movement_right:
#                     # print("\r‚¨ÖÔ∏è  Moving Right    ")
#                     MoveRelative(mouse, moveStep, 0)
#
#                 if movement_down:
#                     # print("\r‚¨áÔ∏è  Moving Down    ")
#                     MoveRelative(mouse, 0, moveStep)
#
#                 if movement_up:
#                     # print("\r‚¨ÜÔ∏è  Moving Up      ")
#                     MoveRelative(mouse, 0, -moveStep)
#
#                 # elif key == 'u':
#                 #     print("\rüñ±Ô∏è  Left Click     ")
#                 #     mouse.left_click()
#                 #
#                 # elif key == 'i':
#                 #     print("\rüñ±Ô∏è  Right Click    ")
#                 #     mouse.right_click()
#                 #
#                 # elif key == 'p':
#                 #     print("\nQuit key pressed. Exiting...")
#                 #     break
#                 #
#                 sleep(loopDelay)
#
#     except KeyboardInterrupt:
#         print("\n\nüõë Interrupted by user")
#
#     except Exception as exc:
#         print(f"\n‚ùå Fatal error: {exc}")
#
#     finally:
#         # if oldTerminalSettings:
#             # RestoreTerminal(oldTerminalSettings)
#         print("\nMouse Control Stopped")
#
import threading
# import time

# Click state variables
click_left = False
click_right = False

# Movement state variables
movement_up = False
movement_down = False
movement_left = False
movement_right = False

isMouseMovementLoopOn = False

# def Main():
def Main02():
    global movement_up
    global movement_down
    global movement_left
    global movement_right
    global isMouseMovementLoopOn

    print("Enter movement command: up, down, left, right, stop")
    print("Type 'exit' to quit\n")

    
    print(f"isMouseMovementLoopOn: {isMouseMovementLoopOn}")

    if not isMouseMovementLoopOn:
        # Start independent loop in another thread
        threadMouseMovementLoop = threading.Thread(
            target=MouseMovementLoop,
            daemon=True  # exits automatically when main thread exits
        )
        threadMouseMovementLoop.start()


    while True:
        command = input("Command: ").strip().lower()

        if command == "k":
            movement_up = True
        elif command == "j":
            movement_down = True
        elif command == "l":
            movement_right = True
        elif command == "h":
             movement_left = True
        elif command == "s":
            movement_up = False
            movement_down = False
            movement_left = False
            movement_right = False
        elif command == "exit":
            print("Exiting...")
            break
        else:
            print("Invalid command")
            continue

        # Debug / status output
        print(
            f"UP={movement_up}, "
            f"DOWN={movement_down}, "
            f"LEFT={movement_left}, "
            f"RIGHT={movement_right}"
        )


def Main(cmdInput, cmdStatus):

    global click_left
    global click_right

    global movement_up
    global movement_down
    global movement_left
    global movement_right
    
    global isMouseMovementLoopOn

    # print("Enter movement command: up, down, left, right, stop")
    # print("Type 'exit' to quit\n")

    
    print(f"isMouseMovementLoopOn: {isMouseMovementLoopOn}")

    if not isMouseMovementLoopOn:
        # Start independent loop in another thread
        threadMouseMovementLoop = threading.Thread(
            target=MouseMovementLoop,
            daemon=True  # exits automatically when main thread exits
        )
        threadMouseMovementLoop.start()


    # while True:
    # command = input("command: ").strip().lower()
    if cmdInput.startswith('click'):
        print("inside mouse click")
        if cmdInput == "click_left":
            print("inside mouse click_left")
            # click_left = cmdStatus
            if click_left:
                # def left_click(self, release=True):
                # mouse.left_click(release=cmdStatus)
                Mouse.left_click()
            # mouseAction = True


        if cmdInput == "click_right":
            click_right = cmdStatus

    if cmdInput.startswith('move'):
        if cmdInput == "move_up":
            movement_up = cmdStatus
        elif cmdInput == "move_down":
            movement_down = cmdStatus
        elif cmdInput == "move_left":
             movement_left = cmdStatus
        elif cmdInput == "move_right":
            movement_right = cmdStatus

    if cmdInput == "stop":
        movement_up = False
        movement_down = False
        movement_left = False
        movement_right = False

    # debug / status output
    print(
        f"up={movement_up}, "
        f"down={movement_down}, "
        f"left={movement_left}, "
        f"right={movement_right}"
    )

# if __name__ == "__main__":
#     Main()

